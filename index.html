<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Herramienta de Despliegue</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f8f9fa;
    }
    .login-container {
      max-width: 400px;
      margin: 80px auto;
      padding: 30px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    .btn-gradient {
      background: linear-gradient(to right, blue, red);
      color: white;
      border: none;
      padding: 10px;
      border-radius: 8px;
      font-weight: bold;
      transition: 0.3s;
    }
    .btn-gradient:hover {
      opacity: 0.9;
      transform: scale(1.05);
    }
    .checklist {
      text-align: left;
      max-width: 700px;
      margin: auto;
    }
    .checklist h5 {
      margin-top: 20px;
      font-weight: bold;
    }
  </style>
</head>
<body>

  <div id="contenedor" class="container"></div>

  <script>
    const contenedor = document.getElementById("contenedor");

    // Pantalla de login
function mostrarLogin() {
  contenedor.innerHTML = `
    <div class="login-container">
      <h3 class="text-center mb-4 fw-bold">Iniciar Sesión</h3>
      <form onsubmit="event.preventDefault(); verificarLogin();">
        <div class="mb-3">
          <label for="usuario" class="form-label">Usuario</label>
          <input type="text" class="form-control" id="usuario" required>
        </div>
        <div class="mb-3">
          <label for="contrasena" class="form-label">Contraseña</label>
          <input type="password" class="form-control" id="contrasena" required>
        </div>
        <button type="submit" class="btn-gradient w-100">Ingresar</button>
      </form>
    </div>
  `;
}

// Lista de usuarios válidos
const usuarios = [
  { usuario: "admin", contrasena: "password" },
  { usuario: "admin2", contrasena: "password2" }
];

// Validación
function validarLogin(usuario, contrasena) {
  return usuarios.some(u => u.usuario === usuario && u.contrasena === contrasena);
}

function verificarLogin() {
  const user = document.getElementById("usuario").value;
  const pass = document.getElementById("contrasena").value;

  if (validarLogin(user, pass)) {
    mostrarNormas(); // ✅ redirige a la nueva pantalla con ISO 9001 y 27001
  } else {
    alert("Usuario o contraseña incorrectos");
  }
}

// 3️⃣ FUNCIONES PARA GUARDAR / CARGAR CHECKLIST (aquí va lo de localStorage)
// ---------------------------
const KEY_AUDITOR_ESTADOS = "auditor_estados_v1";
const KEY_AUDITOR_OBS = "auditor_obs_v1";

function cargarAuditorEstados() {
  try { return JSON.parse(localStorage.getItem(KEY_AUDITOR_ESTADOS)) || {}; } catch { return {}; }
}

function guardarAuditorEstados(obj) {
  localStorage.setItem(KEY_AUDITOR_ESTADOS, JSON.stringify(obj));
}

function cargarAuditorObs() {
  try { return JSON.parse(localStorage.getItem(KEY_AUDITOR_OBS)) || {}; } catch { return {}; }
}

function guardarAuditorObs(obj) {
  localStorage.setItem(KEY_AUDITOR_OBS, JSON.stringify(obj));
}


// Nueva pantalla después del login
function mostrarNormas() {
  contenedor.innerHTML = `
    <div class="text-center mt-5">
      <h2 class="fw-bold">Seleccione la norma a aplicar</h2>
      <p class="mb-4">Elija el sistema de gestión con el que desea trabajar:</p>

      <div class="d-grid gap-3 col-6 mx-auto">
        <button class="btn btn-primary btn-lg" onclick="mostrarResponsables()">ISO 9001 - Sistema de Gestión de la Calidad</button>
        <button class="btn btn-secondary btn-lg" onclick="mostrarISO27001()">ISO 27001 - Seguridad de la Información</button>
      </div>

      <div class="text-center mt-4 small text-muted">Diseñado por Daniel Berrio</div>
    </div>
  `;
}

// Aquí tu función actual de mostrarResponsables sigue igual
// (Implementador, Capacitador y Auditor ya definidos)

function mostrarISO27001() {
  contenedor.innerHTML = `
    <div class="text-center mt-5">
      <h2 class="fw-bold">Módulo ISO 27001</h2>
      <p class="mb-4">En construcción: Sistema de Gestión de Seguridad de la Información</p>
      <p>Próximamente incluirá controles basados en los Anexos A y medidas de riesgo.</p>
      <button class="btn btn-secondary mt-3" onclick="mostrarNormas()">⬅ Volver</button>
    </div>
  `;
}

// Reemplaza esta funcion
function mostrarISO27001() {
  contenedor.innerHTML =
    '<div class="text-center mt-5">' +
      '<h2 class="fw-bold">Modulo ISO 27001</h2>' +
      '<p class="mb-3">Sistema de Gestion de Seguridad de la Informacion (SGSI)</p>' +
      '<div class="d-grid gap-2 col-6 mx-auto">' +
        '<button class="btn btn-primary" onclick="mostrarRegistro27001()">Ir al registro</button>' +
        '<button class="btn btn-outline-secondary" onclick="mostrarNormas()">Volver</button>' +
      '</div>' +
      '<div class="text-center mt-4 small text-muted">Disenado por Daniel Berrio</div>' +
    '</div>';
}

// Si aun no la tienes, agrega esta (al enviar abre el checklist)
function mostrarRegistro27001() {
  contenedor.innerHTML =
    '<div class="mt-5">'
  + '  <h2 class="fw-bold text-center">Registro del SGSI (ISO 27001)</h2>'
  + '  <p class="text-center mb-4">Complete los datos antes de continuar al checklist:</p>'
  + '  <form id="formRegistro27001" class="col-10 col-lg-8 mx-auto">'
  + '    <div class="row g-3">'
  + '      <div class="col-md-6">'
  + '        <label class="form-label">Razon social</label>'
  + '        <input id="rz27001" type="text" class="form-control" required>'
  + '      </div>'
  + '      <div class="col-md-6">'
  + '        <label class="form-label">NIT</label>'
  + '        <input id="nit27001" type="text" class="form-control" required>'
  + '      </div>'
  + '      <div class="col-md-6">'
  + '        <label class="form-label">Representante legal</label>'
  + '        <input id="rep27001" type="text" class="form-control" required>'
  + '      </div>'
  + '      <div class="col-md-6">'
  + '        <label class="form-label">Sector economico</label>'
  + '        <input id="sec27001" type="text" class="form-control" required>'
  + '      </div>'
  + '      <div class="col-md-6">'
  + '        <label class="form-label">Tipo de empresa</label>'
  + '        <input id="tipo27001" type="text" class="form-control" required>'
  + '      </div>'
  + '      <div class="col-md-6">'
  + '        <label class="form-label">Direccion</label>'
  + '        <input id="dir27001" type="text" class="form-control" required>'
  + '      </div>'
  + '      <div class="col-md-6">'
  + '        <label class="form-label">Telefono</label>'
  + '        <input id="tel27001" type="tel" class="form-control" required>'
  + '      </div>'
  + '      <div class="col-md-6">'
  + '        <label class="form-label">Numero de empleados</label>'
  + '        <input id="emp27001" type="number" class="form-control" required>'
  + '      </div>'
  + '      <div class="col-md-6">'
  + '        <label class="form-label">Email</label>'
  + '        <input id="mail27001" type="email" class="form-control" required>'
  + '      </div>'
  + '      <div class="col-md-6">'
  + '        <label class="form-label">Sitio web</label>'
  + '        <input id="web27001" type="url" class="form-control">'
  + '      </div>'
  + '      <div class="col-md-4">'
  + '        <label class="form-label">Facebook</label>'
  + '        <input id="fb27001" type="url" class="form-control">'
  + '      </div>'
  + '      <div class="col-md-4">'
  + '        <label class="form-label">Instagram</label>'
  + '        <input id="ig27001" type="url" class="form-control">'
  + '      </div>'
  + '      <div class="col-md-4">'
  + '        <label class="form-label">TikTok</label>'
  + '        <input id="tk27001" type="url" class="form-control">'
  + '      </div>'
  + '    </div>'
  + '    <div class="text-center mt-4 d-flex justify-content-center gap-2">'
  + '      <button type="submit" class="btn btn-primary">Registrar y continuar</button>'
  + '      <button type="button" class="btn btn-outline-secondary" onclick="mostrarDashboard27001()">Volver al Dashboard 27001</button>'
  + '    </div>'
  + '  </form>'
  + '  <div class="text-center mt-4 small text-muted">Disenado por Daniel Berrio</div>'
  + '</div>';

  // Precarga opcional: si ya existe un registro guardado, lo carga en los inputs
  try {
    var prev = JSON.parse(localStorage.getItem("iso27001_registro")) || null;
    if (prev) {
      var map = {
        rz27001: "razon_social", nit27001: "nit", rep27001: "representante", sec27001: "sector",
        tipo27001: "tipo", dir27001: "direccion", tel27001: "telefono", emp27001: "empleados",
        mail27001: "email", web27001: "web", fb27001: "facebook", ig27001: "instagram", tk27001: "tiktok"
      };
      Object.keys(map).forEach(function(id){
        if (typeof prev[map[id]] !== "undefined") {
          var el = document.getElementById(id);
          if (el) el.value = String(prev[map[id]]);
        }
      });
    }
  } catch(e){ /* noop */ }

  document.getElementById("formRegistro27001").addEventListener("submit", function(e){
    e.preventDefault();
    // Guardar en localStorage con las mismas llaves semanticas que usas en 9001
    var data = {
      razon_social: document.getElementById("rz27001").value.trim(),
      nit: document.getElementById("nit27001").value.trim(),
      representante: document.getElementById("rep27001").value.trim(),
      sector: document.getElementById("sec27001").value.trim(),
      tipo: document.getElementById("tipo27001").value.trim(),
      direccion: document.getElementById("dir27001").value.trim(),
      telefono: document.getElementById("tel27001").value.trim(),
      empleados: document.getElementById("emp27001").value.trim(),
      email: document.getElementById("mail27001").value.trim(),
      web: document.getElementById("web27001").value.trim(),
      facebook: document.getElementById("fb27001").value.trim(),
      instagram: document.getElementById("ig27001").value.trim(),
      tiktok: document.getElementById("tk27001").value.trim()
    };
    try { localStorage.setItem("iso27001_registro", JSON.stringify(data)); } catch(e){ /* noop */ }
    mostrarChecklist27001();
  });
}


function mostrarChecklist27001() {
  // claves de storage
  const KEY_EST = "iso27001_estados_v1";
  const KEY_OBS = "iso27001_obs_v1";

  // helpers de storage
  const cargarEstados = () => { try { return JSON.parse(localStorage.getItem(KEY_EST)) || {}; } catch(e){ return {}; } };
  const guardarEstados = (o) => localStorage.setItem(KEY_EST, JSON.stringify(o));
  const cargarObs = () => { try { return JSON.parse(localStorage.getItem(KEY_OBS)) || {}; } catch(e){ return {}; } };
  const guardarObs = (o) => localStorage.setItem(KEY_OBS, JSON.stringify(o));

  // helpers de filas
  const capRow = (titulo) =>
    '<tr class="table-secondary"><th colspan="5" class="text-start fw-bold">' + titulo + '</th></tr>';

  const itemRow = (cap, item, texto) =>
    '<tr>' +
      '<td class="text-center">'+cap+'</td>' +
      '<td class="text-center">'+item+'</td>' +
      '<td>'+texto+'</td>' +
      '<td>' +
        '<div class="d-flex align-items-center gap-2">' +
          '<select class="form-select estado-select" data-item="'+item+'">' +
            '<option value="">Seleccione...</option>' +
            '<option value="Cumple">Cumple</option>' +
            '<option value="En proceso">En proceso</option>' +
            '<option value="No cumple">No cumple</option>' +
          '</select>' +
          '<span class="estado-indicador" style="width:20px;height:20px;border-radius:50%;display:inline-block;border:1px solid #ccc;"></span>' +
        '</div>' +
      '</td>' +
      '<td><input type="text" class="form-control obs-input" data-item="'+item+'" placeholder="Escriba observaciones..."></td>' +
    '</tr>';

  // construir el tbody como string (fuera del template literal)
  let rowsHtml = "";
  rowsHtml += capRow("Capitulo 4 - Contexto de la organizacion");
  rowsHtml += itemRow("4","4.1","Se identifican y actualizan los factores internos y externos que afectan al SGSI?");
  rowsHtml += itemRow("4","4.2","Se identifican las partes interesadas relevantes y sus necesidades/expectativas?");
  rowsHtml += itemRow("4","4.3","Esta definido y documentado el alcance del SGSI (limites, interfaces, exclusiones)?");
  rowsHtml += itemRow("4","4.4","Esta establecido, implementado, mantenido y mejorado el SGSI y sus procesos?");

  rowsHtml += capRow("Capitulo 5 - Liderazgo");
  rowsHtml += itemRow("5","5.1","La alta direccion demuestra liderazgo y compromiso con el SGSI?");
  rowsHtml += itemRow("5","5.2","Existe politica de seguridad adecuada, comunicada y disponible?");
  rowsHtml += itemRow("5","5.3","Estan asignadas y comunicadas responsabilidades y autoridades del SGSI?");

  rowsHtml += capRow("Capitulo 6 - Planificacion");
  rowsHtml += itemRow("6","6.1.1","Se planifican acciones para abordar riesgos y oportunidades del SGSI?");
  rowsHtml += itemRow("6","6.1.2","Se realiza apreciacion de riesgos de SI con criterios definidos y resultados trazables?");
  rowsHtml += itemRow("6","6.1.3","Se aplica tratamiento de riesgos; seleccion de controles y SoA vigente?");
  rowsHtml += itemRow("6","6.2","Se establecen objetivos de seguridad medibles y coherentes con la politica?");
  rowsHtml += itemRow("6","6.3","Se planifican los cambios del SGSI de forma controlada?");

  rowsHtml += capRow("Capitulo 7 - Apoyo");
  rowsHtml += itemRow("7","7.1","Se proporcionan recursos necesarios para el SGSI?");
  rowsHtml += itemRow("7","7.2","El personal posee competencia requerida y existen evidencias?");
  rowsHtml += itemRow("7","7.3","Existe concienciacion sobre politica, objetivos, roles y consecuencias?");
  rowsHtml += itemRow("7","7.4","Se gestionan comunicaciones internas y externas del SGSI?");
  rowsHtml += itemRow("7","7.5.1","La informacion documentada requerida esta establecida y controlada?");
  rowsHtml += itemRow("7","7.5.2","La documentacion se crea/actualiza correctamente (identificacion, revision, aprobacion)?");
  rowsHtml += itemRow("7","7.5.3","Se controla distribucion, acceso, almacenamiento, retencion y disposicion de la documentacion?");

  rowsHtml += capRow("Capitulo 8 - Operacion");
  rowsHtml += itemRow("8","8.1","Se planifican y controlan las operaciones del SGSI (incl. procesos externalizados y cambios)?");
  rowsHtml += itemRow("8","8.2","Se realizan apreciaciones de riesgo operativas cuando cambian condiciones o amenazas?");
  rowsHtml += itemRow("8","8.3","Se ejecutan planes de tratamiento y controles definidos (SoA actualizado)?");

  rowsHtml += capRow("Capitulo 9 - Evaluacion del desempeno");
  rowsHtml += itemRow("9","9.1","Se realiza seguimiento, medicion, analisis y evaluacion del SGSI?");
  rowsHtml += itemRow("9","9.2","Se ejecutan auditorias internas planificadas con informes y acciones?");
  rowsHtml += itemRow("9","9.3","La direccion revisa el SGSI y decide cambios/mejoras/recursos?");

  rowsHtml += capRow("Capitulo 10 - Mejora");
  rowsHtml += itemRow("10","10.1","Se gestionan no conformidades y acciones correctivas con verificacion de eficacia?");
  rowsHtml += itemRow("10","10.2","Se evidencia la mejora continua de la idoneidad y eficacia del SGSI?");

  // fecha y hora
  const ahora = new Date();
  const fecha = ahora.toLocaleDateString("es-CO");
  const hora = ahora.toLocaleTimeString("es-CO", { hour: "2-digit", minute: "2-digit", hour12: true });

  // render del modulo
  contenedor.innerHTML = `
    <div class="mt-5">
      <h2 class="fw-bold text-center">Modulo del Auditor ISO/IEC 27001</h2>
      <p class="text-center mb-4">Checklist del SGSI (Capitulos 4 - 10)</p>

      <div class="d-flex justify-content-center mb-4 gap-3">
        <div>
          <label class="form-label fw-bold">Fecha:</label>
          <input type="text" class="form-control" value="${fecha}" readonly>
        </div>
        <div>
          <label class="form-label fw-bold">Hora de inicio:</label>
          <input type="text" class="form-control" value="${hora}" readonly>
        </div>
      </div>

      <div class="text-center mb-3">
        <label for="filtro27001" class="form-label fw-bold">Filtrar por estado:</label>
        <select id="filtro27001" class="form-select d-inline-block w-auto ms-2">
          <option value="todos">Todos</option>
          <option value="Cumple">Cumple</option>
          <option value="En proceso">En proceso</option>
          <option value="No cumple">No cumple</option>
        </select>
        <button id="btnReiniciar27001" class="btn btn-danger btn-sm ms-3">Reiniciar checklist</button>
      </div>

      <div class="table-responsive">
        <table id="tabla27001" class="table table-bordered table-striped align-middle">
          <thead class="table-primary text-center">
            <tr>
              <th>Cap.</th>
              <th>Item</th>
              <th>Requisito</th>
              <th>Estado</th>
              <th>Observaciones</th>
            </tr>
          </thead>
          <tbody id="tbody27001">
            ${rowsHtml}
          </tbody>
        </table>
      </div>

      <div class="text-center">
        <button class="btn btn-success mt-3" id="btnExport27001">Descargar Informe</button>
      </div>
      <div class="text-center mt-2">
        <button class="btn btn-outline-primary" onclick="mostrarDashboard27001()">Volver al Dashboard</button>

      </div>

      <div class="text-center mt-4 small text-muted">Disenado por Daniel Berrio</div>
    </div>
  `;

  // restaurar estados/obs y listeners
  const estados = cargarEstados();
  const obs = cargarObs();

  document.querySelectorAll("#tbody27001 .estado-select").forEach(function(sel){
    const k = sel.getAttribute("data-item");
    if (estados[k]) sel.value = estados[k];
    pintarIndicador(sel);
    sel.addEventListener("change", function(){
      estados[k] = sel.value || "";
      guardarEstados(estados);
      pintarIndicador(sel);
      aplicarFiltro(); // respeta filtro activo
    });
  });

  document.querySelectorAll("#tbody27001 .obs-input").forEach(function(inp){
    const k = inp.getAttribute("data-item");
    if (Object.prototype.hasOwnProperty.call(obs, k)) inp.value = obs[k];
    inp.addEventListener("input", function(){
      obs[k] = inp.value;
      guardarObs(obs);
    });
  });

  // filtro
  const filtro = document.getElementById("filtro27001");
  function aplicarFiltro(){
    const val = filtro.value;
    document.querySelectorAll("#tbody27001 tr").forEach(function(row){
      const sel = row.querySelector(".estado-select");
      if (!sel) { row.style.display = ""; return; } // filas de capitulo
      const v = sel.value || "";
      row.style.display = (val === "todos" || val === v) ? "" : "none";
    });
  }
  filtro.addEventListener("change", aplicarFiltro);

  // reinicio
  document.getElementById("btnReiniciar27001").addEventListener("click", function(){
    document.querySelectorAll("#tbody27001 .estado-select").forEach(function(sel){
      sel.value = "";
      pintarIndicador(sel);
    });
    document.querySelectorAll("#tbody27001 .obs-input").forEach(function(inp){
      inp.value = "";
    });
    filtro.value = "todos";
    aplicarFiltro();
    guardarEstados({});
    guardarObs({});
  });

  // exportar
  document.getElementById("btnExport27001").addEventListener("click", function(){
    const filas = [];
    filas.push(["Cap.","Item","Requisito","Estado","Observaciones"]);
    document.querySelectorAll("#tbody27001 tr").forEach(function(row){
      const c = row.cells;
      if (!c || c.length < 5) return; // salta filas de capitulo
      const estado = row.querySelector("select") ? row.querySelector("select").value : "";
      const obsv = row.querySelector("input") ? row.querySelector("input").value : "";
      filas.push([c[0].innerText, c[1].innerText, c[2].innerText, estado, obsv]);
    });
    const csv = "data:text/csv;charset=utf-8," + filas.map(f => f.map(x => '"'+x.replaceAll('"','""')+'"').join(",")).join("\n");
    const a = document.createElement("a");
    a.href = encodeURI(csv);
    a.download = "checklist_iso27001.csv";
    a.click();
  });

  // util: color del indicador
  function pintarIndicador(selectEl){
    const indicador = selectEl.parentElement.querySelector(".estado-indicador");
    const v = selectEl.value;
    indicador.style.backgroundColor =
      v === "Cumple" ? "green" :
      v === "En proceso" ? "orange" :
      v === "No cumple" ? "red" : "transparent";
  }

  // aplica filtro inicial
  aplicarFiltro();
}


function mostrarDashboard27001() {
  // Lee estados guardados por el checklist 27001
  var estados = {};
  try { estados = JSON.parse(localStorage.getItem("iso27001_estados_v1")) || {}; } catch(e){ estados = {}; }
  var valores = Object.values(estados);
  var totalItems = valores.length;
  var cntCumple = valores.filter(function(v){ return v === "Cumple"; }).length;
  var cntProceso = valores.filter(function(v){ return v === "En proceso"; }).length;
  var cntNoCumple = valores.filter(function(v){ return v === "No cumple"; }).length;
  var porcentajeCumple = totalItems > 0 ? Math.round((cntCumple / totalItems) * 100) : 0;

  contenedor.innerHTML =
    '<div class="mt-5">'
  + '  <h2 class="fw-bold text-center">Dashboard ISO/IEC 27001</h2>'
  + '  <p class="text-center text-muted mb-4">Resumen del SGSI (capitulos 4 - 10)</p>'

  // Grupo de botones superior (igual estilo que 9001, simetrico)
  + '  <div class="text-center my-3">'
  + '    <div class="btn-group">'
  + '      <button class="btn btn-outline-secondary" onclick="mostrarChecklistAuditor()">ISO 9001</button>'
  + '      <button class="btn btn-primary" onclick="mostrarDashboard27001()">ISO 27001</button>'
  + '    </div>'
  + '  </div>'

  + '  <div class="container">'
  + '    <div class="row g-3">'
  // Tarjeta 1: KPI %
  + '      <div class="col-md-3">'
  + '        <div class="card text-center"><div class="card-body">'
  + '          <h6 class="text-muted mb-2">Cumplimiento Auditor</h6>'
  + '          <div class="display-6">' + porcentajeCumple + '%</div>'
  + '          <small>' + cntCumple + '/' + totalItems + ' items "Cumple"</small>'
  + '        </div></div>'
  + '      </div>'

  // Tarjeta 2: Desglose
  + '      <div class="col-md-3">'
  + '        <div class="card text-center"><div class="card-body">'
  + '          <h6 class="text-muted mb-2">Checklist Auditor</h6>'
  + '          <div>Cumple: ' + cntCumple + '</div>'
  + '          <div>En proceso: ' + cntProceso + '</div>'
  + '          <div>No cumple: ' + cntNoCumple + '</div>'
  + '        </div></div>'
  + '      </div>'

  // Tarjeta 3: Acceso rapido 27001
  + '      <div class="col-md-3">'
  + '        <div class="card text-center"><div class="card-body">'
  + '          <h6 class="text-muted mb-2">Acceso rapido 27001</h6>'
  + '          <div class="d-grid gap-2">'
  + '            <button class="btn btn-success btn-sm" onclick="mostrarChecklist27001()">Ir al Checklist</button>'
  + '            <button class="btn btn-outline-secondary btn-sm" onclick="mostrarRegistro27001()">Ir al Registro</button>'
  + '          </div>'
  + '        </div></div>'
  + '      </div>'

  // Tarjeta 4: Global / Navegacion
  + '      <div class="col-md-3">'
  + '        <div class="card text-center"><div class="card-body">'
  + '          <h6 class="text-muted mb-2">Global</h6>'
  + '          <div class="d-grid gap-2">'
  + '            <button class="btn btn-primary btn-sm" onclick="mostrarDashboard27001()">Dashboard General</button>'
  + '            <button class="btn btn-outline-primary btn-sm" onclick="mostrarNormas()">Normas</button>'
  + '          </div>'
  + '        </div></div>'
  + '      </div>'

  + '    </div>'  // row
  + '  </div>'    // container

  + '  <div class="text-center mt-4 small text-muted">Disenado por Daniel Berrio</div>'
  + '</div>';
}




    // Pantalla de selección de responsables
    function mostrarResponsables() {
      contenedor.innerHTML = `
        <div class="text-center mt-5">
          <h2 class="fw-bold">Seleccione el responsable</h2>
          <p class="mb-4">Elija una opción para continuar:</p>
          <div class="d-grid gap-3 col-6 mx-auto">
            <button class="btn btn-primary" onclick="mostrarImplementador()">Implementador</button>
            <button class="btn btn-primary" onclick="mostrarCapacitador()">Capacitador</button>
            <button class="btn btn-primary" onclick="mostrarAuditor()">Auditor</button>
          </div>
          <div class="text-center mt-3 small text-muted">Diseñado por Daniel Berrio</div>
        </div>
      `;
    }

    // Pantalla del Implementador
// Pantalla del Implementador con sub-opciones
function mostrarImplementador() {
  contenedor.innerHTML = `
    <div class="text-center mt-5">
      <h2 class="fw-bold">Módulo del Implementador</h2>
      <p>Seleccione una opción:</p>
      <div class="d-grid gap-3 col-6 mx-auto">
        <button class="btn btn-primary" onclick="mostrarChecklistImplementacion()">Checklist de Implementación</button>
        <button class="btn btn-primary" onclick="mostrarRegistroIncidencias()">Registro de Incidencias</button>
        <button class="btn btn-primary" onclick="mostrarIntegracion()">Integración con otros módulos</button>
        <button class="btn btn-primary" onclick="mostrarEvidenciasImplementador()">Gestión documental</button>
      </div>
      <div class="text-center mt-3 small text-muted">Diseñado por Daniel Berrio</div>
    </div>
  `;
}


function mostrarDashboard() {
  // Auditor: conteo de estados
  const estados = cargarAuditorEstados(); // { "4.1": "Cumple", ... }
  const totalItems = Object.keys(estados).length;
  const cntCumple = Object.values(estados).filter(v => v === "Cumple").length;
  const cntProceso = Object.values(estados).filter(v => v === "En proceso").length;
  const cntNoCumple = Object.values(estados).filter(v => v === "No cumple").length;

  // Capacitador: evidencias
  const capRaw = localStorage.getItem("evidencias_capacitacion");
  const cap = capRaw ? JSON.parse(capRaw) : [];
  const capTotal = cap.length;
  const capRevisados = cap.filter(x => x.estado === "Revisado").length;
  const capAprobados = cap.filter(x => x.aprobado === "Aprobado").length;

  // Implementador: documentos
  const implRaw = localStorage.getItem("evidencias_implementador");
  const impl = implRaw ? JSON.parse(implRaw) : [];
  const implTotal = impl.length;
  const implAprobados = impl.filter(x => x.aprobado === "Aprobado").length;

  // % cumplimiento simple (si no hay datos, 0)
  const porcentajeCumple = totalItems > 0 ? Math.round((cntCumple / totalItems) * 100) : 0;

  contenedor.innerHTML = `
    <div class="mt-5">
      <h2 class="fw-bold text-center">Dashboard General</h2>
      <p class="text-center text-muted mb-4">Resumen de ISO 9001</p>

      <div class="container">
        <div class="row g-3">
          <!-- KPIs Auditor -->
          <div class="col-md-3">
            <div class="card text-center">
              <div class="card-body">
                <h6 class="text-muted mb-2">Cumplimiento Auditor</h6>
                <div class="display-6">${porcentajeCumple}%</div>
                <small>${cntCumple}/${totalItems} ítems “Cumple”</small>
              </div>
            </div>
          </div>

          <!-- Capacitador -->
          <div class="col-md-3">
            <div class="card text-center">
              <div class="card-body">
                <h6 class="text-muted mb-2">Capacitador</h6>
                <div class="display-6">${capRevisados}/${capTotal}</div>
                <small>Revisados</small><br/>
                <small>Aprobados: ${capAprobados}</small>
              </div>
            </div>
          </div>

          <!-- Implementador -->
          <div class="col-md-3">
            <div class="card text-center">
              <div class="card-body">
                <h6 class="text-muted mb-2">Implementador</h6>
                <div class="display-6">${implAprobados}/${implTotal}</div>
                <small>Documentos aprobados</small>
              </div>
            </div>
          </div>

          <!-- Auditor (detalle) -->
          <div class="col-md-3">
            <div class="card text-center">
              <div class="card-body">
                <h6 class="text-muted mb-2">Checklist Auditor</h6>
                <div>Cumple: ${cntCumple}</div>
                <div>En proceso: ${cntProceso}</div>
                <div>No cumple: ${cntNoCumple}</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Acciones rápidas -->
        <div class="text-center my-4">
          <div class="btn-group">
            <button class="btn btn-primary" onclick="mostrarResponsables()">ISO 9001</button>
            <button class="btn btn-outline-secondary" onclick="mostrarDashboard27001()">ISO 27001</button>
          </div>
        </div>

        <div class="text-center">
          <button class="btn btn-success me-2" onclick="mostrarChecklistAuditor()">Ir a Checklist Auditor</button>
          <button class="btn btn-info me-2" onclick="mostrarEvidenciasImplementador()">Gestión documental (Implementador)</button>
          <button class="btn btn-warning" onclick="mostrarCapacitacionEvidencias()">Evidencias (Capacitador)</button>
        </div>
      </div>

      <div class="text-center mt-4 small text-muted">Diseñado por Daniel Berrio</div>
    </div>
  `;
}


// 1️⃣ Checklist de Implementación
function mostrarChecklistImplementacion() {
  // Obtener fecha y hora actual
  const ahora = new Date();
  const fecha = ahora.toLocaleDateString("es-CO");
  const hora = ahora.toLocaleTimeString("es-CO", { hour: '2-digit', minute: '2-digit' });

   contenedor.innerHTML = `
    <div class="mt-5">
      <h3 class="fw-bold text-center">Checklist de Implementación</h3>

      <!-- Registro de fecha y hora -->
      <div class="d-flex justify-content-center mb-4 gap-3">
        <div>
          <label class="form-label fw-bold">Fecha de implementación:</label>
          <input type="text" class="form-control" value="${fecha}" readonly>
        </div>
        <div>
          <label class="form-label fw-bold">Hora de inicio:</label>
          <input type="text" class="form-control" value="${hora}" readonly>
        </div>
      </div>

      <table class="table table-bordered">
        <thead>
          <tr>
            <th>Proceso</th>
            <th>Tarea</th>
            <th>Estado</th>
            <th>Responsable</th>
            <th>Fecha límite</th>
            <th>Observaciones</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Gestión de calidad</td>
            <td>Definir procedimientos</td>
            <td>
              <select class="form-select">
                <option>No iniciado</option>
                <option>En progreso</option>
                <option>Completado</option>
              </select>
            </td>
            <td><input type="text" class="form-control" placeholder="Nombre"></td>
            <td><input type="date" class="form-control"></td>
            <td><input type="text" class="form-control" placeholder="Observaciones"></td>
          </tr>
        </tbody>
      </table>
      
      <button class="btn btn-secondary mt-3" onclick="mostrarImplementador()">Volver</button>
      <div class="text-center mt-2">
  <button class="btn btn-outline-primary" onclick="mostrarDashboard()">Volver al Dashboard</button>
</div>

    </div>
  `;
}


// 2️⃣ Registro de incidencias y acciones correctivas
function mostrarRegistroIncidencias() {
  // Obtener fecha y hora actual
const ahora = new Date();
  const fecha = ahora.toLocaleDateString("es-CO");
  const hora = ahora.toLocaleTimeString("es-CO", { hour: "2-digit", minute: "2-digit", hour12: true });

  contenedor.innerHTML = `
    <div class="mt-5">
      <h3 class="fw-bold text-center">Registro de Incidencias</h3>

      <!-- Registro de fecha y hora -->
      <div class="d-flex justify-content-center mb-4 gap-3">
        <div>
          <label class="form-label fw-bold">Fecha de registro:</label>
          <input type="text" class="form-control" value="${fecha}" readonly>
        </div>
        <div>
          <label class="form-label fw-bold">Hora de registro:</label>
          <input type="text" class="form-control" value="${hora}" readonly>
        </div>
      </div>

      <table class="table table-bordered">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Incidencia</th>
            <th>Acción Correctiva</th>
            <th>Responsable</th>
            <th>Estado</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><input type="date" class="form-control"></td>
            <td><input type="text" class="form-control" placeholder="Describa la incidencia"></td>
            <td><input type="text" class="form-control" placeholder="Acción correctiva"></td>
            <td><input type="text" class="form-control" placeholder="Responsable"></td>
            <td>
              <select class="form-select">
                <option>Pendiente</option>
                <option>En proceso</option>
                <option>Resuelto</option>
              </select>
            </td>
          </tr>
        </tbody>
      </table>
      
      <button class="btn btn-secondary mt-3" onclick="mostrarImplementador()">Volver</button>
      <div class="text-center mt-2">
  <button class="btn btn-outline-primary" onclick="mostrarDashboard()">Volver al Dashboard</button>
</div>

    </div>
  `;
}

// 3️⃣ Integración con otros módulos
function mostrarIntegracion() {
  // Obtener fecha y hora actual
const ahora = new Date();
  const fecha = ahora.toLocaleDateString("es-CO");
  const hora = ahora.toLocaleTimeString("es-CO", { hour: "2-digit", minute: "2-digit", hour12: true });

  contenedor.innerHTML = `
    <div class="mt-5 text-center">
      <h3 class="fw-bold">Integración con otros módulos</h3>
      <p>Indique el estado de integración con Capacitador y Auditor:</p>

      <!-- Registro de fecha y hora -->
      <div class="d-flex justify-content-center mb-4 gap-3">
        <div>
          <label class="form-label fw-bold">Fecha de registro:</label>
          <input type="text" class="form-control" value="${fecha}" readonly>
        </div>
        <div>
          <label class="form-label fw-bold">Hora de registro:</label>
          <input type="text" class="form-control" value="${hora}" readonly>
        </div>
      </div>

      <table class="table table-bordered mx-auto" style="max-width:600px;">
        <thead>
          <tr>
            <th>Módulo</th>
            <th>Estado</th>
            <th>Observaciones</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Capacitador</td>
            <td>
              <select class="form-select">
                <option>No iniciado</option>
                <option>En proceso</option>
                <option>Integrado</option>
              </select>
            </td>
            <td><input type="text" class="form-control" placeholder="Observaciones"></td>
          </tr>
          <tr>
            <td>Auditor</td>
            <td>
              <select class="form-select">
                <option>No iniciado</option>
                <option>En proceso</option>
                <option>Integrado</option>
              </select>
            </td>
            <td><input type="text" class="form-control" placeholder="Observaciones"></td>
          </tr>
        </tbody>
      </table>

      <button class="btn btn-secondary mt-3" onclick="mostrarImplementador()">Volver</button>
      <div class="text-center mt-2">
  <button class="btn btn-outline-primary" onclick="mostrarDashboard()">Volver al Dashboard</button>
</div>

    </div>
  `;
}

const KEY_EVIDENCIAS_IMPL = "evidencias_implementador";
let evidenciasImpl = [];

function cargarEvidenciasImpl() {
  try {
    const raw = localStorage.getItem(KEY_EVIDENCIAS_IMPL);
    return raw ? JSON.parse(raw) : [];
  } catch {
    return [];
  }
}
function guardarEvidenciasImpl(arr) {
  localStorage.setItem(KEY_EVIDENCIAS_IMPL, JSON.stringify(arr));
}

function mostrarEvidenciasImplementador() {
  evidenciasImpl = cargarEvidenciasImpl();

  contenedor.innerHTML = `
    <div class="mt-5">
      <h2 class="fw-bold text-center">Gestión Documental del Implementador</h2>
      <p class="text-center mb-4">Sube procedimientos, instructivos o registros controlados y gestiona su estado de aprobación.</p>

      <!-- Carga de archivo -->
      <div class="card col-10 col-lg-8 mx-auto mb-4">
        <div class="card-body">
          <div class="row g-3 align-items-end">
            <div class="col-md-4">
              <label class="form-label">Documento</label>
              <input type="file" id="archivoImpl" class="form-control" />
            </div>
            <div class="col-md-4">
              <label class="form-label">Nombre visible</label>
              <input type="text" id="nombreVisibleImpl" class="form-control" placeholder="Ej: Procedimiento de control de calidad">
            </div>
            <div class="col-md-4">
              <label class="form-label">Versión</label>
              <input type="text" id="versionImpl" class="form-control" placeholder="Ej: 1.0">
            </div>
            <div class="col-12 text-end">
              <button class="btn btn-primary" id="btnAgregarImpl">Agregar documento</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Tabla de documentos -->
      <div class="table-responsive col-12 col-lg-10 mx-auto">
        <table class="table table-bordered align-middle" id="tablaImpl">
          <thead class="table-primary text-center">
            <tr>
              <th style="min-width:200px;">Documento</th>
              <th>Versión</th>
              <th>Estado</th>
              <th>Aprobación</th>
              <th style="min-width:220px;">Observaciones</th>
              <th>Fecha / Hora</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            ${evidenciasImpl.map((e, idx) => filaImplHTML(e, idx)).join("")}
          </tbody>
        </table>
      </div>

      <div class="text-center mt-3">
        <button class="btn btn-secondary" onclick="mostrarImplementador()">⬅ Volver</button>
      </div>
      <div class="text-center mt-2">
  <button class="btn btn-outline-primary" onclick="mostrarDashboard()">Volver al Dashboard</button>
</div>


      <div class="text-center mt-4 small text-muted">Diseñado por Daniel Berrio</div>
    </div>
  `;

  document.getElementById("btnAgregarImpl").addEventListener("click", onAgregarImpl);
  document.querySelector("#tablaImpl tbody").addEventListener("change", onTablaImplChange);
  document.querySelector("#tablaImpl tbody").addEventListener("click", onTablaImplClick);
}

function filaImplHTML(e, idx) {
  return `
    <tr data-index="${idx}">
      <td>${e.url ? `<a href="${e.url}" target="_blank">${escapeHTML(e.nombre)}</a>` : escapeHTML(e.nombre)}</td>
      <td class="text-center">${escapeHTML(e.version)}</td>
      <td>
        <select class="form-select sel-estado">
          <option value="Borrador" ${e.estado === "Borrador" ? "selected" : ""}>Borrador</option>
          <option value="En revisión" ${e.estado === "En revisión" ? "selected" : ""}>En revisión</option>
          <option value="Aprobado" ${e.estado === "Aprobado" ? "selected" : ""}>Aprobado</option>
        </select>
      </td>
      <td>
        <select class="form-select sel-aprob">
          <option value="No aprobado" ${e.aprobado === "No aprobado" ? "selected" : ""}>No aprobado</option>
          <option value="Aprobado" ${e.aprobado === "Aprobado" ? "selected" : ""}>Aprobado</option>
        </select>
      </td>
      <td><input type="text" class="form-control inp-obs" value="${escapeHTML(e.obs || "")}" placeholder="Observaciones..."></td>
      <td class="text-center">
        <div>${escapeHTML(e.fecha)}</div>
        <div class="small text-muted">${escapeHTML(e.hora)}</div>
      </td>
      <td class="text-center">
        <button class="btn btn-sm btn-outline-danger btn-del">Eliminar</button>
      </td>
    </tr>
  `;
}

function onAgregarImpl() {
  const fileInput = document.getElementById("archivoImpl");
  const nombreVisible = document.getElementById("nombreVisibleImpl").value.trim();
  const version = document.getElementById("versionImpl").value.trim();

  if (!fileInput.files || fileInput.files.length === 0) {
    alert("Seleccione un archivo para continuar.");
    return;
  }

  const file = fileInput.files[0];
  const url = URL.createObjectURL(file);

  const ahora = new Date();
  const fecha = ahora.toLocaleDateString("es-CO");
  const hora = ahora.toLocaleTimeString("es-CO", { hour: "2-digit", minute: "2-digit", hour12: true });

  const doc = {
    nombre: nombreVisible || file.name,
    url,
    version: version || "1.0",
    estado: "Borrador",
    aprobado: "No aprobado",
    obs: "",
    fecha,
    hora
  };

  evidenciasImpl.push(doc);
  guardarEvidenciasImpl(evidenciasImpl);
  document.querySelector("#tablaImpl tbody").insertAdjacentHTML("beforeend", filaImplHTML(doc, evidenciasImpl.length - 1));

  fileInput.value = "";
  document.getElementById("nombreVisibleImpl").value = "";
  document.getElementById("versionImpl").value = "";
}

function onTablaImplChange(e) {
  const tr = e.target.closest("tr[data-index]");
  if (!tr) return;
  const idx = parseInt(tr.getAttribute("data-index"), 10);
  if (Number.isNaN(idx)) return;

  if (e.target.classList.contains("sel-estado")) {
    evidenciasImpl[idx].estado = e.target.value;
  }
  if (e.target.classList.contains("sel-aprob")) {
    evidenciasImpl[idx].aprobado = e.target.value;
  }
  if (e.target.classList.contains("inp-obs")) {
    evidenciasImpl[idx].obs = e.target.value;
  }

  guardarEvidenciasImpl(evidenciasImpl);
}

function onTablaImplClick(e) {
  if (!e.target.classList.contains("btn-del")) return;
  const tr = e.target.closest("tr[data-index]");
  const idx = parseInt(tr.getAttribute("data-index"), 10);
  if (Number.isNaN(idx)) return;

  if (confirm("¿Eliminar este documento?")) {
    if (evidenciasImpl[idx].url) {
      try { URL.revokeObjectURL(evidenciasImpl[idx].url); } catch {}
    }
    evidenciasImpl.splice(idx, 1);
    guardarEvidenciasImpl(evidenciasImpl);
    mostrarEvidenciasImplementador();
  }
}

// Escapar texto para evitar HTML en celdas
function escapeHTML(str) {
  return String(str)
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}


// MÓDULO CAPACITADOR (menú)

function mostrarCapacitador() {
  contenedor.innerHTML = `
    <div class="text-center mb-3 mt-5">
      <h2 class="fw-bold">Módulo del Capacitador</h2>
      <p class="mb-4">Seleccione un apartado:</p>
    </div>
    <div class="d-grid gap-2 col-6 mx-auto">
      <button class="btn btn-primary" onclick="mostrarObjetivos()">Objetivos</button>
      <button class="btn btn-primary" onclick="mostrarPHVA()">Ciclo PHVA</button>
      <button class="btn btn-primary" onclick="mostrarOrganizacion()">Organización</button>
      <button class="btn btn-primary" onclick="mostrarLiderazgo()">Liderazgo</button>
      <button class="btn btn-primary" onclick="mostrarPlanificacion()">Planificación</button>
      <button class="btn btn-primary" onclick="mostrarApoyo()">Apoyo</button>
      <button class="btn btn-primary" onclick="mostrarOperacion()">Operación</button>
      <button class="btn btn-primary" onclick="mostrarDesempeno()">Desempeño</button>
      <button class="btn btn-primary" onclick="mostrarMejora()">Mejora</button>
      <button class="btn btn-primary" onclick="mostrarIntroVideoCapacitador()">Subir/gestionar documentos</button>
    </div>
    <div class="text-center mt-3 small text-muted">Diseñado por Daniel Berrio</div>
  `;
}

// 🔗 Video de YouTube para el Capacitador
const VIDEO_CAP_URL = "https://youtu.be/tsajVWg7JC0";

// Pantalla intermedia: muestra el video y un botón "Continuar"
function mostrarIntroVideoCapacitador() {
  contenedor.innerHTML = `
    <div class="mt-5">
      <h2 class="fw-bold text-center">Capacitador – Subir/gestionar documentos</h2>
      <p class="text-center mb-3">Antes de continuar, revisa este video:</p>

      <div class="col-11 col-lg-8 mx-auto">
        <div class="card mb-3">
          <div class="card-body">
            <p class="mb-2">
              <a href="${VIDEO_CAP_URL}" target="_blank" rel="noopener">
                🔗 Ver en YouTube
              </a>
            </p>
            <div class="ratio ratio-16x9">
              <iframe
                src="https://www.youtube.com/embed/tsajVWg7JC0"
                title="Video de capacitación"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                allowfullscreen
              ></iframe>
            </div>
          </div>
        </div>

        <div class="text-center d-flex justify-content-center gap-2">
          <button class="btn btn-primary" id="btnContinuarCap">Continuar</button>
          <button class="btn btn-outline-secondary" onclick="mostrarCapacitador()">Volver</button>
        </div>

        <div class="text-center mt-4 small text-muted">Diseñado por Daniel Berrio</div>
      </div>
    </div>
  `;

  // Al pulsar continuar, muestra el gestor de documentos
  document.getElementById("btnContinuarCap").addEventListener("click", () => {
    // Si quieres que no vuelva a mostrar el video, descomenta la siguiente línea:
    // sessionStorage.setItem("cap_video_visto", "1");
    mostrarCapacitacionEvidencias();
  });
}


// =======================================
// CAPACITADOR: SUBIR / GESTIONAR DOCUMENTOS
// =======================================

// Clave de almacenamiento
const KEY_EVIDENCIAS_CAP = "evidencias_capacitacion";

// Estado en memoria
let evidenciasCap = [];

// Utilidades de storage
function cargarEvidenciasCap() {
  try {
    const raw = localStorage.getItem(KEY_EVIDENCIAS_CAP);
    return raw ? JSON.parse(raw) : [];
  } catch {
    return [];
  }
}
function guardarEvidenciasCap(arr) {
  localStorage.setItem(KEY_EVIDENCIAS_CAP, JSON.stringify(arr));
}

// Render principal del submódulo
function mostrarCapacitacionEvidencias() {
  evidenciasCap = cargarEvidenciasCap();

  contenedor.innerHTML = `
    <div class="mt-5">
      <h2 class="fw-bold text-center">Capacitación – Gestión de Evidencias</h2>
      <p class="text-center mb-4">Sube documentos (manuales, guías, comprobantes, etc.) y gestiona su revisión/aprobación.</p>

      <!-- Carga de archivo -->
      <div class="card col-10 col-lg-8 mx-auto mb-4">
        <div class="card-body">
          <div class="row g-3 align-items-end">
            <div class="col-md-6">
              <label class="form-label">Documento</label>
              <input type="file" id="archivoCap" class="form-control" />
            </div>
            <div class="col-md-6">
              <label class="form-label">Nombre visible (opcional)</label>
              <input type="text" id="nombreVisibleCap" class="form-control" placeholder="Ej: Guía de uso del formato SMART">
            </div>
            <div class="col-12 text-end">
              <button class="btn btn-primary" id="btnAgregarEvidencia">Agregar</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Tabla de evidencias -->
      <div class="table-responsive col-12 col-lg-10 mx-auto">
        <table class="table table-bordered align-middle" id="tablaEvidenciasCap">
          <thead class="table-primary text-center">
            <tr>
              <th style="min-width:220px;">Documento</th>
              <th>Estado</th>
              <th>Aprobación</th>
              <th style="min-width:220px;">Observaciones</th>
              <th style="min-width:140px;">Fecha/Hora</th>
              <th style="min-width:120px;">Acciones</th>
            </tr>
          </thead>
          <tbody>
            ${evidenciasCap.map((e, idx) => filaEvidenciaHTML(e, idx)).join("")}
          </tbody>
        </table>
      </div>

      <div class="text-center mt-3">
        <button class="btn btn-secondary" onclick="mostrarCapacitador()">⬅ Volver</button>
        <div class="text-center mt-2">
  <button class="btn btn-outline-primary" onclick="mostrarDashboard()">Volver al Dashboard</button>
</div>

      </div>

      <div class="text-center mt-4 small text-muted">Diseñado por Daniel Berrio</div>
    </div>
  `;

  // Listeners
  document.getElementById("btnAgregarEvidencia").addEventListener("click", onAgregarEvidencia);
  // Delegación de eventos para cambios en selects/observaciones/borrar
  document.querySelector("#tablaEvidenciasCap tbody").addEventListener("change", onTablaChange);
  document.querySelector("#tablaEvidenciasCap tbody").addEventListener("click", onTablaClick);
}

// Plantilla de fila de la tabla
function filaEvidenciaHTML(e, idx) {
  return `
    <tr data-index="${idx}">
      <td>
        ${e.url
          ? `<a href="${e.url}" target="_blank" rel="noopener">${escapeHTML(e.nombre)}</a>`
          : `<span>${escapeHTML(e.nombre)}</span>`}
      </td>
      <td>
        <select class="form-select sel-estado">
          <option value="No revisado" ${e.estado === "No revisado" ? "selected" : ""}>No revisado</option>
          <option value="Revisado" ${e.estado === "Revisado" ? "selected" : ""}>Revisado</option>
        </select>
      </td>
      <td>
        <select class="form-select sel-aprobacion">
          <option value="No aprobado" ${e.aprobado === "No aprobado" ? "selected" : ""}>No aprobado</option>
          <option value="Aprobado" ${e.aprobado === "Aprobado" ? "selected" : ""}>Aprobado</option>
        </select>
      </td>
      <td>
        <input type="text" class="form-control inp-obs" value="${escapeHTML(e.observaciones || "")}" placeholder="Observaciones..." />
      </td>
      <td class="text-center">
        <div>${escapeHTML(e.fecha)}</div>
        <div class="small text-muted">${escapeHTML(e.hora)}</div>
      </td>
      <td class="text-center">
        <button class="btn btn-sm btn-outline-danger btn-borrar">Eliminar</button>
      </td>
    </tr>
  `;
}

// Agregar evidencia (desde input file)
function onAgregarEvidencia() {
  const inputFile = document.getElementById("archivoCap");
  const nombreVisible = document.getElementById("nombreVisibleCap").value.trim();

  if (!inputFile.files || inputFile.files.length === 0) {
    alert("Selecciona un archivo para continuar.");
    return;
  }

  const file = inputFile.files[0];

  // URL local temporal (no sube a servidor; funciona en esta sesión)
  const url = URL.createObjectURL(file);

  // Fecha/hora local (Colombia)
  const ahora = new Date();
  const fecha = ahora.toLocaleDateString("es-CO");
  const hora = ahora.toLocaleTimeString("es-CO", { hour: "2-digit", minute: "2-digit", hour12: true });

  const evidencia = {
    nombre: nombreVisible || file.name,
    url,
    estado: "No revisado",
    aprobado: "No aprobado",
    observaciones: "",
    fecha,
    hora
  };

  evidenciasCap.push(evidencia);
  guardarEvidenciasCap(evidenciasCap);

  // Agregar fila al DOM
  const tbody = document.querySelector("#tablaEvidenciasCap tbody");
  tbody.insertAdjacentHTML("beforeend", filaEvidenciaHTML(evidencia, evidenciasCap.length - 1));

  // Limpiar inputs
  inputFile.value = "";
  document.getElementById("nombreVisibleCap").value = "";
}

// Manejar cambios (estado / aprobación / observaciones)
function onTablaChange(e) {
  const tr = e.target.closest("tr[data-index]");
  if (!tr) return;
  const idx = parseInt(tr.getAttribute("data-index"), 10);
  if (Number.isNaN(idx)) return;

  if (e.target.classList.contains("sel-estado")) {
    evidenciasCap[idx].estado = e.target.value;
  }
  if (e.target.classList.contains("sel-aprobacion")) {
    evidenciasCap[idx].aprobado = e.target.value;
  }
  if (e.target.classList.contains("inp-obs")) {
    evidenciasCap[idx].observaciones = e.target.value;
  }

  guardarEvidenciasCap(evidenciasCap);
}

// Manejar clicks (eliminar)
function onTablaClick(e) {
  if (!e.target.classList.contains("btn-borrar")) return;
  const tr = e.target.closest("tr[data-index]");
  if (!tr) return;
  const idx = parseInt(tr.getAttribute("data-index"), 10);
  if (Number.isNaN(idx)) return;

  if (confirm("¿Eliminar esta evidencia?")) {
    // liberar URL temporal si existía
    if (evidenciasCap[idx].url) {
      try { URL.revokeObjectURL(evidenciasCap[idx].url); } catch {}
    }
    evidenciasCap.splice(idx, 1);
    guardarEvidenciasCap(evidenciasCap);
    // Re-render para reindexar
    mostrarCapacitacionEvidencias();
  }
}

// Utilidad: escapar HTML básico
function escapeHTML(str) {
  return String(str)
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}

// 🔹 Submenú de Objetivos con los links
function mostrarObjetivos() {
  contenedor.innerHTML = `
    <div class="mt-5">
      <h2 class="fw-bold text-center">Objetivos</h2>
      <p class="text-center mb-4">Seleccione un documento:</p>
      <ul class="list-group col-6 mx-auto">
        <li class="list-group-item">
          <a href="https://docs.google.com/spreadsheets/d/1entrTfrmBxHAU8Ywvt1S9wK7dVYZh9_N/edit?usp=sharing&ouid=115465540193721348792&rtpof=true&sd=true" target="_blank">
            📄 Objetivos e indicadores SMART
          </a>
        </li>
        <li class="list-group-item">
          <a href="https://docs.google.com/spreadsheets/d/1XniTslEk8lZa9YUe85y1eAFgSZPy2yX1/edit?usp=sharing&ouid=115465540193721348792&rtpof=true&sd=true" target="_blank">
            📄 Objetivos de calidad
          </a>
        </li>
        <li class="list-group-item">
          <a href="https://docs.google.com/spreadsheets/d/1Sr4zFh03GQb8A2a5bDnLpV-ACNldc4ai/edit?usp=sharing&ouid=115465540193721348792&rtpof=true&sd=true" target="_blank">
            📄 Plantilla indicadores de desempeño
          </a>
        </li>
        <li class="list-group-item">
          <a href="https://docs.google.com/spreadsheets/d/1P8P16b7bfJpJ8XM7_e7TlZ13OpWXr1AY/edit?usp=sharing&ouid=115465540193721348792&rtpof=true&sd=true" target="_blank">
            📄 Indicadores por área funcional
          </a>
        </li>
      </ul>
      <div class="text-center mt-3">
        <button class="btn btn-secondary" onclick="mostrarCapacitador()">⬅ Volver</button>
      </div>
    </div>
  `;
}

// 🔹 Submenú de Ciclo PHVA con los links
function mostrarPHVA() {
  contenedor.innerHTML = `
    <div class="mt-5">
      <h2 class="fw-bold text-center">Ciclo PHVA</h2>
      <p class="text-center mb-4">Seleccione un documento:</p>
      <ul class="list-group col-6 mx-auto">
        <li class="list-group-item">
          <a href="https://docs.google.com/spreadsheets/d/1cL-6QGqe8S6wwxnR_65dPYaV4Zq9Tb03/edit?usp=sharing&ouid=115465540193721348792&rtpof=true&sd=true" target="_blank">
            📄 Seguimiento, medición, análisis y evaluación
          </a>
        </li>
        <li class="list-group-item">
          <a href="https://docs.google.com/spreadsheets/d/1MAg9-xN9qXd1BvsEqwnGfK3jzivJinPb/edit?usp=sharing&ouid=115465540193721348792&rtpof=true&sd=true" target="_blank">
            📄 Matriz de riesgo
          </a>
        </li>
        <li class="list-group-item">
          <a href="https://docs.google.com/spreadsheets/d/1vL6cfh3qpTiIKu3hM1uC4WukDoRjRMs2/edit?usp=sharing&ouid=115465540193721348792&rtpof=true&sd=true" target="_blank">
            📄 Acta cambio proyecto
          </a>
        </li>
      </ul>
      <div class="text-center mt-3">
        <button class="btn btn-secondary" onclick="mostrarCapacitador()">⬅ Volver</button>
      </div>
    </div>
  `;
}

// 🔹 Submenú de Organización con los links
function mostrarOrganizacion() {
  contenedor.innerHTML = `
    <div class="mt-5">
      <h2 class="fw-bold text-center">Organización</h2>
      <p class="text-center mb-4">Seleccione un documento:</p>
      <ul class="list-group col-6 mx-auto">
        <li class="list-group-item">
          <a href="https://docs.google.com/spreadsheets/d/1jz-yk2hImMcfMzcBMqBj74KtM7kltn6G/edit?usp=sharing&ouid=115465540193721348792&rtpof=true&sd=true" target="_blank">
            📄 Plantilla alcance
          </a>
        </li>
        <li class="list-group-item">
          <a href="https://docs.google.com/spreadsheets/d/1Ayb2tqj2zNF874XjjvZuya_ilMRVSD8D/edit?usp=sharing&ouid=115465540193721348792&rtpof=true&sd=true" target="_blank">
            📄 Plantilla de procesos
          </a>
        </li>
        <li class="list-group-item">
          <a href="https://docs.google.com/spreadsheets/d/1DT1aQQhtfX6La8N8JfC0PJ01p2K6PaLX/edit?usp=sharing&ouid=115465540193721348792&rtpof=true&sd=true" target="_blank">
            📄 Organigrama
          </a>
        </li>
        <li class="list-group-item">
          <a href="https://docs.google.com/spreadsheets/d/1QZgRalKW2N1DzX-9e-ChzmbPZN0AIoXs/edit?usp=sharing&ouid=115465540193721348792&rtpof=true&sd=true" target="_blank">
            📄 Plantilla partes interesadas
          </a>
        </li>
        <li class="list-group-item">
          <a href="https://docs.google.com/spreadsheets/d/1eW0hRVbcv57UO8ZFyYDEzIXGNyVXX9Gt/edit?usp=sharing&ouid=115465540193721348792&rtpof=true&sd=true" target="_blank">
            📄 Matriz FODA
          </a>
        </li>
        <li class="list-group-item">
          <a href="https://docs.google.com/spreadsheets/d/1ccPMywtiuAqWPjAZ9vAzDI6jc3DakxBw/edit?usp=sharing&ouid=115465540193721348792&rtpof=true&sd=true" target="_blank">
            📄 Plantilla PESTAL
          </a>
        </li>
        <li class="list-group-item">
          <a href="https://docs.google.com/spreadsheets/d/1eGf4oSNb_AlqFdZvtKhBLIk5t7wRxXuV/edit?usp=sharing&ouid=115465540193721348792&rtpof=true&sd=true" target="_blank">
            📄 Plantilla 5 fuerzas de Porter
          </a>
        </li>
      </ul>
      <div class="text-center mt-3">
        <button class="btn btn-secondary" onclick="mostrarCapacitador()">⬅ Volver</button>
      </div>
    </div>
  `;
}

// 🔹 Submenú de Liderazgo con los links
function mostrarLiderazgo() {
  contenedor.innerHTML = `
    <div class="mt-5">
      <h2 class="fw-bold text-center">Liderazgo</h2>
      <p class="text-center mb-4">Seleccione un documento:</p>
      <ul class="list-group col-6 mx-auto">
        <li class="list-group-item">
          <a href="https://docs.google.com/spreadsheets/d/1sG1avjS4WoB0ADtnmw-tgULmqmet520d/edit?usp=sharing&ouid=115465540193721348792&rtpof=true&sd=true" target="_blank">
            📄 Checklist liderazgo actual
          </a>
        </li>
        <li class="list-group-item">
          <a href="https://docs.google.com/spreadsheets/d/19pURueHpINBIfK03MUGkPmJ_iHmQwjMO/edit?usp=sharing&ouid=115465540193721348792&rtpof=true&sd=true" target="_blank">
            📄 Plantilla política de calidad
          </a>
        </li>
      </ul>
      <div class="text-center mt-3">
        <button class="btn btn-secondary" onclick="mostrarCapacitador()">⬅ Volver</button>
      </div>
    </div>
  `;
}

// 🔹 Submenú de Planificación con los links
function mostrarPlanificacion() {
  contenedor.innerHTML = `
    <div class="mt-5">
      <h2 class="fw-bold text-center">Planificación</h2>
      <p class="text-center mb-4">Seleccione un documento:</p>
      <ul class="list-group col-6 mx-auto">
        <li class="list-group-item">
          <a href="https://docs.google.com/spreadsheets/d/1aztCrro79KUyeYgthdjdx85Q8MhV_Pq9/edit?usp=sharing&ouid=115465540193721348792&rtpof=true&sd=true" target="_blank">
            📄 Planificación de los cambios
          </a>
        </li>
      </ul>
      <div class="text-center mt-3">
        <button class="btn btn-secondary" onclick="mostrarCapacitador()">⬅ Volver</button>
      </div>
    </div>
  `;
}

// 🔹 Submenú de Apoyo con los links
function mostrarApoyo() {
  contenedor.innerHTML = `
    <div class="mt-5">
      <h2 class="fw-bold text-center">Apoyo</h2>
      <p class="text-center mb-4">Seleccione un documento:</p>
      <ul class="list-group col-8 mx-auto">
        <li class="list-group-item">
          <a href="https://docs.google.com/spreadsheets/d/1UpolpMvh8kXauJhwM5KvBzHRk3hbSb2n/edit?usp=sharing&ouid=115465540193721348792&rtpof=true&sd=true" target="_blank">
            📄 Medición de condiciones psicosociales
          </a>
        </li>
        <li class="list-group-item">
          <a href="https://docs.google.com/spreadsheets/d/1kXmoTtscwtDid1tZvanAxj8pcIfCsleA/edit?usp=sharing&ouid=115465540193721348792&rtpof=true&sd=true" target="_blank">
            📄 Medición de condiciones físicas
          </a>
        </li>
        <li class="list-group-item">
          <a href="https://docs.google.com/spreadsheets/d/12Z5LPfT3kQR0d2YonSiIKdtPZ-tw6-9W/edit?usp=sharing&ouid=115465540193721348792&rtpof=true&sd=true" target="_blank">
            📄 Formato competencia
          </a>
        </li>
        <li class="list-group-item">
          <a href="https://docs.google.com/spreadsheets/d/1mIZB0OdlUfkYxO0PQUF3VvEHKmj98TSi/edit?usp=sharing&ouid=115465540193721348792&rtpof=true&sd=true" target="_blank">
            📄 Formato toma de conciencia
          </a>
        </li>
        <li class="list-group-item">
          <a href="https://docs.google.com/spreadsheets/d/1KnlH9-ecw3XN0QD8B9U5o3R30njfG3sw/edit?usp=sharing&ouid=115465540193721348792&rtpof=true&sd=true" target="_blank">
            📄 Formato información documentada
          </a>
        </li>
        <li class="list-group-item">
          <a href="https://docs.google.com/spreadsheets/d/11K10uK2uI9PfccFSygo8NIr5s4-H2LkQ/edit?usp=sharing&ouid=115465540193721348792&rtpof=true&sd=true" target="_blank">
            📄 Control de infraestructura
          </a>
        </li>
        <li class="list-group-item">
          <a href="https://docs.google.com/spreadsheets/d/14M9qrpy1m3rb-h_AVcuDTtKwd57PYAuc/edit?usp=sharing&ouid=115465540193721348792&rtpof=true&sd=true" target="_blank">
            📄 Formato recursos de seguimiento y medición
          </a>
        </li>
        <li class="list-group-item">
          <a href="https://drive.google.com/file/d/1C3pgSQ4NyEoy1bYE4SaueouND9aJdf2e/view?usp=sharing" target="_blank">
            📄 PDF gestión del conocimiento
          </a>
        </li>
        <li class="list-group-item">
          <a href="https://docs.google.com/spreadsheets/d/1ot6-ajF3ntLkKWwVXhP89IuJDDr___w3/edit?usp=sharing&ouid=115465540193721348792&rtpof=true&sd=true" target="_blank">
            📄 Plantilla requerimiento de personal
          </a>
        </li>
      </ul>
      <div class="text-center mt-3">
        <button class="btn btn-secondary" onclick="mostrarCapacitador()">⬅ Volver</button>
      </div>
    </div>
  `;
}

// 🔹 Submenú de Operación con los links
function mostrarOperacion() {
  contenedor.innerHTML = `
    <div class="mt-5">
      <h2 class="fw-bold text-center">Operación</h2>
      <p class="text-center mb-4">Seleccione un documento:</p>
      <ul class="list-group col-8 mx-auto">
        <li class="list-group-item">
          <a href="https://docs.google.com/spreadsheets/d/1f1H01pJ-3vRvb2xBN6K4QNjCv31QOw0L/edit?usp=sharing&ouid=115465540193721348792&rtpof=true&sd=true" target="_blank">
            📄 Planificación y control operacional
          </a>
        </li>
        <li class="list-group-item">
          <a href="https://docs.google.com/spreadsheets/d/1v5zAP9tK-BH7kk-OO_L79zAgs5eB2A4p/edit?usp=sharing&ouid=115465540193721348792&rtpof=true&sd=true" target="_blank">
            📄 Requisitos para los productos y servicios
          </a>
        </li>
        <li class="list-group-item">
          <a href="https://docs.google.com/spreadsheets/d/1xgvfhOccUXNx2qam_6ZLmZblrV656lPR/edit?usp=sharing&ouid=115465540193721348792&rtpof=true&sd=true" target="_blank">
            📄 Control de los procesos externos
          </a>
        </li>
        <li class="list-group-item">
          <a href="https://docs.google.com/spreadsheets/d/18fN5cS-CcvB1GgP-npSorGATSfMD3u12/edit?usp=sharing&ouid=115465540193721348792&rtpof=true&sd=true" target="_blank">
            📄 Identificación y trazabilidad
          </a>
        </li>
        <li class="list-group-item">
          <a href="https://docs.google.com/spreadsheets/d/1zZoxmPL0yS0Gm-w6KgE5NxOrhTLrbGP_/edit?usp=sharing&ouid=115465540193721348792&rtpof=true&sd=true" target="_blank">
            📄 Liberación de los productos y servicios
          </a>
        </li>
        <li class="list-group-item">
          <a href="https://docs.google.com/spreadsheets/d/1ldhyVlG924Gf3B9UuVAltgu1wu4G85aa/edit?usp=sharing&ouid=115465540193721348792&rtpof=true&sd=true" target="_blank">
            📄 Control de salidas no conformes
          </a>
        </li>
      </ul>
      <div class="text-center mt-3">
        <button class="btn btn-secondary" onclick="mostrarCapacitador()">⬅ Volver</button>
      </div>
    </div>
  `;
}

// 🔹 Submenú de Desempeño con los links
function mostrarDesempeno() {
  contenedor.innerHTML = `
    <div class="mt-5">
      <h2 class="fw-bold text-center">Desempeño</h2>
      <p class="text-center mb-4">Seleccione un documento:</p>
      <ul class="list-group col-8 mx-auto">
        <li class="list-group-item">
          <a href="https://docs.google.com/spreadsheets/d/1cL-6QGqe8S6wwxnR_65dPYaV4Zq9Tb03/edit?usp=sharing&ouid=115465540193721348792&rtpof=true&sd=true" target="_blank">
            📄 Seguimiento, medición, análisis y evaluación
          </a>
        </li>
        <li class="list-group-item">
          <a href="https://docs.google.com/spreadsheets/d/1Sr4zFh03GQb8A2a5bDnLpV-ACNldc4ai/edit?usp=sharing&ouid=115465540193721348792&rtpof=true&sd=true" target="_blank">
            📄 Plantilla indicadores de desempeño
          </a>
        </li>
        <li class="list-group-item">
          <a href="https://docs.google.com/spreadsheets/d/1P8P16b7bfJpJ8XM7_e7TlZ13OpWXr1AY/edit?usp=sharing&ouid=115465540193721348792&rtpof=true&sd=true" target="_blank">
            📄 Multiplantilla indicadores por área funcional
          </a>
        </li>
      </ul>
      <div class="text-center mt-3">
        <button class="btn btn-secondary" onclick="mostrarCapacitador()">⬅ Volver</button>
      </div>
    </div>
  `;
}

// 🔹 Submenú de Mejora con el enlace de 10.2 No conformidad y acción correctiva
function mostrarMejora() {
  contenedor.innerHTML = `
    <div class="mt-5">
      <h2 class="fw-bold text-center">Mejora</h2>
      <p class="text-center mb-4">Seleccione un documento:</p>
      <ul class="list-group col-8 mx-auto">
        <li class="list-group-item">
          <a href="https://docs.google.com/spreadsheets/d/1IOwHprWTNb-bPzsTG4X7yxLXdERm-B1l/edit?usp=sharing&ouid=115465540193721348792&rtpof=true&sd=true" target="_blank">
            📄 10.2 No conformidad y acción correctiva
          </a>
        </li>
      </ul>
      <div class="text-center mt-3">
        <button class="btn btn-secondary" onclick="mostrarCapacitador()">⬅ Volver</button>
      </div>
    </div>
  `;
}

function mostrarAuditor() {
  contenedor.innerHTML = `
    <div class="mt-5">
      <h2 class="fw-bold text-center">Registro del Auditor</h2>
      <p class="text-center mb-4">Complete los datos antes de continuar al checklist:</p>
      
      <form id="formAuditor" class="col-8 mx-auto">
        <div class="row g-3">
          <div class="col-md-6"><label class="form-label">Razón social</label><input type="text" class="form-control" required></div>
          <div class="col-md-6"><label class="form-label">NIT</label><input type="text" class="form-control" required></div>
          <div class="col-md-6"><label class="form-label">Representante legal</label><input type="text" class="form-control" required></div>
          <div class="col-md-6"><label class="form-label">Sector económico</label><input type="text" class="form-control" required></div>
          <div class="col-md-6"><label class="form-label">Tipo de empresa</label><input type="text" class="form-control" required></div>
          <div class="col-md-6"><label class="form-label">Dirección</label><input type="text" class="form-control" required></div>
          <div class="col-md-6"><label class="form-label">Teléfono</label><input type="tel" class="form-control" required></div>
          <div class="col-md-6"><label class="form-label">Número de empleados</label><input type="number" class="form-control" required></div>
          <div class="col-md-6"><label class="form-label">Email</label><input type="email" class="form-control" required></div>
          <div class="col-md-6"><label class="form-label">Sitio web</label><input type="url" class="form-control"></div>
          <div class="col-md-4"><label class="form-label">Facebook</label><input type="url" class="form-control"></div>
          <div class="col-md-4"><label class="form-label">Instagram</label><input type="url" class="form-control"></div>
          <div class="col-md-4"><label class="form-label">TikTok</label><input type="url" class="form-control"></div>
        </div>
        
        <div class="text-center mt-4">
          <button type="submit" class="btn btn-primary">Registrar</button>
        </div>
      </form>

      <div class="text-center mt-4 small text-muted">Diseñado por Daniel Berrio</div>
    </div>
  `;
    // Cuando se envía el formulario, pasamos al checklist
  document.getElementById("formAuditor").addEventListener("submit", function (e) {
    e.preventDefault();
    mostrarChecklistAuditor();
  });
}

    // Pantalla del Auditor con checklist
function mostrarChecklistAuditor() {
  // ⏱️ Fecha/hora local (Colombia)
  const ahora = new Date();
  const fecha = ahora.toLocaleDateString("es-CO");
  const hora = ahora.toLocaleTimeString("es-CO", { hour: "2-digit", minute: "2-digit", hour12: true });

  contenedor.innerHTML = `
    <div class="mt-5">
      <h2 class="fw-bold text-center">Módulo del Auditor</h2>
      <p class="text-center mb-4">Checklist ISO 9001:2015 (Capítulo 4.1 – 10.3)</p>

      <!-- Registro de fecha y hora -->
      <div class="d-flex justify-content-center mb-4 gap-3">
        <div>
          <label class="form-label fw-bold">Fecha de la auditoría:</label>
          <input type="text" class="form-control" value="${fecha}" readonly>
        </div>
        <div>
          <label class="form-label fw-bold">Hora de inicio:</label>
          <input type="text" class="form-control" value="${hora}" readonly>
        </div>
      </div>

      <!-- Filtro por estado -->
      <div class="text-center mb-3">
        <label for="filtroEstado" class="form-label fw-bold">Filtrar por estado:</label>
        <select id="filtroEstado" class="form-select d-inline-block w-auto ms-2">
          <option value="todos">Todos</option>
          <option value="Cumple">Cumple</option>
          <option value="En proceso">En proceso</option>
          <option value="No cumple">No cumple</option>
        </select>
        <button id="btnReiniciar" class="btn btn-danger btn-sm ms-3">Reiniciar checklist</button>
      </div>
      
      <div class="table-responsive">
        <table id="tablaAuditor" class="table table-bordered table-striped align-middle">
          <thead class="table-primary text-center">
            <tr>
              <th>Cap.</th>
              <th>Ítem</th>
              <th>Requisito</th>
              <th>Estado</th>
              <th>Observaciones</th>
            </tr>
          </thead>
          <tbody>
            <!-- CAPÍTULO 4 -->
            <tr><td>4</td><td>4.1</td><td>¿Se han identificado factores internos y externos?</td><td>${estado()}</td><td>${observaciones()}</td></tr>
            <tr><td>4</td><td>4.2</td><td>¿Se han identificado las partes interesadas relevantes?</td><td>${estado()}</td><td>${observaciones()}</td></tr>
            <tr><td>4</td><td>4.3</td><td>¿Se ha definido el alcance del SGC?</td><td>${estado()}</td><td>${observaciones()}</td></tr>
            <tr><td>4</td><td>4.4</td><td>¿Se han establecido los procesos necesarios del SGC?</td><td>${estado()}</td><td>${observaciones()}</td></tr>

            <!-- CAPÍTULO 5 -->
            <tr><td>5</td><td>5.1</td><td>¿La alta dirección demuestra liderazgo y compromiso?</td><td>${estado()}</td><td>${observaciones()}</td></tr>
            <tr><td>5</td><td>5.2</td><td>¿Se ha definido y comunicado la política de calidad?</td><td>${estado()}</td><td>${observaciones()}</td></tr>
            <tr><td>5</td><td>5.3</td><td>¿Se han definido roles, responsabilidades y autoridades?</td><td>${estado()}</td><td>${observaciones()}</td></tr>

            <!-- CAPÍTULO 6 -->
            <tr><td>6</td><td>6.1</td><td>¿Se han identificado riesgos y oportunidades?</td><td>${estado()}</td><td>${observaciones()}</td></tr>
            <tr><td>6</td><td>6.2</td><td>¿Se han establecido objetivos de calidad medibles?</td><td>${estado()}</td><td>${observaciones()}</td></tr>
            <tr><td>6</td><td>6.3</td><td>¿Se planifican los cambios del SGC de manera controlada?</td><td>${estado()}</td><td>${observaciones()}</td></tr>

            <!-- CAPÍTULO 7 -->
            <tr><td>7</td><td>7.1</td><td>¿Se dispone de los recursos necesarios para el SGC?</td><td>${estado()}</td><td>${observaciones()}</td></tr>
            <tr><td>7</td><td>7.2</td><td>¿Se evalúan competencias y capacitaciones?</td><td>${estado()}</td><td>${observaciones()}</td></tr>
            <tr><td>7</td><td>7.3</td><td>¿El personal es consciente de la política y objetivos?</td><td>${estado()}</td><td>${observaciones()}</td></tr>
            <tr><td>7</td><td>7.4</td><td>¿La comunicación interna y externa es adecuada?</td><td>${estado()}</td><td>${observaciones()}</td></tr>
            <tr><td>7</td><td>7.5</td><td>¿La información documentada está controlada?</td><td>${estado()}</td><td>${observaciones()}</td></tr>

            <!-- CAPÍTULO 8 -->
            <tr><td>8</td><td>8.1</td><td>¿Se planifican y controlan los procesos operativos?</td><td>${estado()}</td><td>${observaciones()}</td></tr>
            <tr><td>8</td><td>8.2</td><td>¿Se determinan los requisitos del cliente?</td><td>${estado()}</td><td>${observaciones()}</td></tr>
            <tr><td>8</td><td>8.3</td><td>¿Se realiza diseño y desarrollo cuando aplica?</td><td>${estado()}</td><td>${observaciones()}</td></tr>
            <tr><td>8</td><td>8.4</td><td>¿Se controlan los proveedores y compras?</td><td>${estado()}</td><td>${observaciones()}</td></tr>
            <tr><td>8</td><td>8.5</td><td>¿Se controla la producción y prestación del servicio?</td><td>${estado()}</td><td>${observaciones()}</td></tr>
            <tr><td>8</td><td>8.6</td><td>¿Se liberan productos y servicios conforme requisitos?</td><td>${estado()}</td><td>${observaciones()}</td></tr>
            <tr><td>8</td><td>8.7</td><td>¿Se gestionan las no conformidades en la entrega?</td><td>${estado()}</td><td>${observaciones()}</td></tr>

            <!-- CAPÍTULO 9 -->
            <tr><td>9</td><td>9.1</td><td>¿Se realiza seguimiento, medición y análisis del SGC?</td><td>${estado()}</td><td>${observaciones()}</td></tr>
            <tr><td>9</td><td>9.1.2</td><td>¿Se mide la satisfacción del cliente?</td><td>${estado()}</td><td>${observaciones()}</td></tr>
            <tr><td>9</td><td>9.2</td><td>¿Se realizan auditorías internas documentadas?</td><td>${estado()}</td><td>${observaciones()}</td></tr>
            <tr><td>9</td><td>9.3</td><td>¿La dirección realiza revisiones del SGC?</td><td>${estado()}</td><td>${observaciones()}</td></tr>

            <!-- CAPÍTULO 10 -->
            <tr><td>10</td><td>10.2</td><td>¿Se gestionan las no conformidades y acciones correctivas?</td><td>${estado()}</td><td>${observaciones()}</td></tr>
            <tr><td>10</td><td>10.3</td><td>¿Se busca la mejora continua del SGC?</td><td>${estado()}</td><td>${observaciones()}</td></tr>
          </tbody>
        </table>
      </div>

      <!-- Botón de exportar -->
      <div class="text-center">
        <button class="btn btn-success mt-3" onclick="exportarChecklist()">Descargar Informe</button>
      </div>

      <div class="text-center mt-2">
        <button class="btn btn-outline-primary" onclick="mostrarDashboard()">Volver al Dashboard</button>
      </div>

      <div class="text-center mt-4 small text-muted">Diseñado por Daniel Berrio</div>
    </div>
  `;

  // ===== Helpers internos =====
  const KEY_AUDITOR_ESTADOS = "auditor_estados_v1";
  const KEY_AUDITOR_OBS = "auditor_obs_v1";
  const cargarAuditorEstados = () => { try { return JSON.parse(localStorage.getItem(KEY_AUDITOR_ESTADOS)) || {}; } catch { return {}; } };
  const guardarAuditorEstados = (obj) => localStorage.setItem(KEY_AUDITOR_ESTADOS, JSON.stringify(obj));
  const cargarAuditorObs = () => { try { return JSON.parse(localStorage.getItem(KEY_AUDITOR_OBS)) || {}; } catch { return {}; } };
  const guardarAuditorObs = (obj) => localStorage.setItem(KEY_AUDITOR_OBS, JSON.stringify(obj));

  const setIndicadorColor = (selectEl) => {
    const indicador = selectEl.parentElement.querySelector(".estado-indicador");
    const v = selectEl.value;
    indicador.style.backgroundColor =
      v === "Cumple" ? "green" :
      v === "En proceso" ? "orange" :
      v === "No cumple" ? "red" : "transparent";
  };

  // Asignar data-item (usa la columna "Ítem")
  document.querySelectorAll("#tablaAuditor tbody tr").forEach(row => {
    const item = row.cells[1]?.textContent?.trim(); // ej: "4.1"
    const select = row.querySelector(".estado-select");
    const inputObs = row.querySelector("input.form-control");
    if (item && select) select.dataset.item = item;
    if (item && inputObs) inputObs.dataset.item = item;
  });

  // Restaurar datos guardados
  const estadosGuardados = cargarAuditorEstados();
  const obsGuardadas = cargarAuditorObs();

  document.querySelectorAll(".estado-select").forEach(select => {
    const item = select.dataset.item;
    if (item && estadosGuardados[item]) {
      select.value = estadosGuardados[item];
    }
    setIndicadorColor(select);
  });

  document.querySelectorAll("#tablaAuditor tbody input.form-control").forEach(inp => {
    const item = inp.dataset.item;
    if (item && obsGuardadas[item] != null) {
      inp.value = obsGuardadas[item];
    }
  });

  // Colores + guardado en cambios
  document.querySelectorAll(".estado-select").forEach(select => {
    select.addEventListener("change", function () {
      setIndicadorColor(this);
      const item = this.dataset.item;
      const estados = cargarAuditorEstados();
      estados[item] = this.value || "";
      guardarAuditorEstados(estados);
      aplicarFiltro(); // re-aplica filtro activo
    });
  });

  document.querySelectorAll("#tablaAuditor tbody input.form-control").forEach(inp => {
    inp.addEventListener("input", function () {
      const item = this.dataset.item;
      const obs = cargarAuditorObs();
      obs[item] = this.value;
      guardarAuditorObs(obs);
    });
  });

  // Filtro por estado
  const filtro = document.getElementById("filtroEstado");
  const aplicarFiltro = () => {
    const val = filtro.value;
    document.querySelectorAll("#tablaAuditor tbody tr").forEach(row => {
      const select = row.querySelector(".estado-select");
      if (!select) return;
      const estado = select.value || "";
      row.style.display = (val === "todos" || val === estado) ? "" : "none";
    });
  };
  filtro.addEventListener("change", aplicarFiltro);

  // Reiniciar checklist (UI + almacenamiento)
  document.getElementById("btnReiniciar").addEventListener("click", () => {
    // limpiar selects + colores
    document.querySelectorAll(".estado-select").forEach(select => {
      select.value = "";
      setIndicadorColor(select);
    });
    // limpiar observaciones
    document.querySelectorAll("#tablaAuditor tbody input.form-control").forEach(inp => inp.value = "");
    // mostrar todas las filas y reset filtro
    document.getElementById("filtroEstado").value = "todos";
    aplicarFiltro();
    // limpiar storage
    guardarAuditorEstados({});
    guardarAuditorObs({});
  });



    // 🎨 Colores en los estados
  document.querySelectorAll(".estado-select").forEach(select => {
    select.addEventListener("change", function () {
      const indicador = this.parentElement.querySelector(".estado-indicador");
      if (this.value === "Cumple") {
        indicador.style.backgroundColor = "green";
      } else if (this.value === "En proceso") {
        indicador.style.backgroundColor = "orange";
      } else if (this.value === "No cumple") {
        indicador.style.backgroundColor = "red";
      } else {
        indicador.style.backgroundColor = "transparent";
      }
    });
  });

  // 🔎 Filtro dinámico
  document.getElementById("filtroEstado").addEventListener("change", function () {
    const filtro = this.value;
    document.querySelectorAll("#tablaAuditor tbody tr").forEach(row => {
      const select = row.querySelector(".estado-select");
      if (!select) return;
      const valor = select.value;
      row.style.display = (filtro === "todos" || filtro === valor) ? "" : "none";
    });
  });

  // 🔄 Botón de reinicio
  document.getElementById("btnReiniciar").addEventListener("click", function () {
    document.querySelectorAll(".estado-select").forEach(select => {
      select.value = ""; // Vuelve a "Seleccione..."
      const indicador = select.parentElement.querySelector(".estado-indicador");
      if (indicador) indicador.style.backgroundColor = "transparent";
    });
    document.querySelectorAll("#tablaAuditor tbody tr").forEach(row => {
      row.style.display = ""; // Muestra todas las filas
    });
    document.getElementById("filtroEstado").value = "todos"; // Reinicia el filtro
  });
}

// Función auxiliar para select con indicador
function estado() {
  return `
    <div class="d-flex align-items-center gap-2">
      <select class="form-select estado-select">
        <option value="">Seleccione...</option>
        <option value="Cumple">Cumple</option>
        <option value="En proceso">En proceso</option>
        <option value="No cumple">No cumple</option>
      </select>
      <span class="estado-indicador" style="width:20px; height:20px; border-radius:50%; display:inline-block; border:1px solid #ccc;"></span>
    </div>
  `;
}

// Función auxiliar para observaciones
function observaciones() {
  return `<input type="text" class="form-control" placeholder="Escriba observaciones...">`;
}



// Función para exportar checklist a CSV
function exportarChecklist() {
  const filas = [];
  const tabla = document.querySelector("table tbody").rows;

  filas.push(["Cap.", "Ítem", "Requisito", "Estado", "Observaciones"]);

  for (let row of tabla) {
    const cap = row.cells[0].innerText;
    const item = row.cells[1].innerText;
    const req = row.cells[2].innerText;
    const estadoSelect = row.querySelector("select");
    const estado = estadoSelect ? estadoSelect.value : "";
    const obsInput = row.querySelector("input");
    const observaciones = obsInput ? obsInput.value : "";
    filas.push([cap, item, req, estado, observaciones]);
  }

  let csvContent = "data:text/csv;charset=utf-8," 
    + filas.map(e => e.map(campo => `"${campo}"`).join(",")).join("\n");

  const link = document.createElement("a");
  link.setAttribute("href", encodeURI(csvContent));
  link.setAttribute("download", "informe_auditoria.csv");
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}



    // Mostrar login al cargar
    mostrarLogin();
  </script>

</body>
</html>
